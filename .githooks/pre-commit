#!/bin/sh
# Pre-commit hook: format staged Rust and TypeScript/JS files.
# Install with: git config core.hooksPath .githooks

set -e

# --- Rust: cargo fmt ---
# Only run if any .rs files are staged
RUST_STAGED=$(git diff --cached --name-only --diff-filter=ACM -- '*.rs')
if [ -n "$RUST_STAGED" ]; then
  echo "Running cargo fmt..."
  (cd server && cargo fmt)
  # Re-stage any files that were reformatted
  echo "$RUST_STAGED" | xargs git add
fi

# --- TypeScript/JS: prettier ---
# Only run if any .ts/.tsx/.js/.json files are staged (excluding node_modules)
TS_STAGED=$(git diff --cached --name-only --diff-filter=ACM -- '*.ts' '*.tsx' '*.js' '*.json' | grep -v node_modules || true)
if [ -n "$TS_STAGED" ]; then
  echo "Running prettier..."
  PRETTIER_BIN="client/node_modules/prettier/bin/prettier.cjs"
  if [ -f "$PRETTIER_BIN" ]; then
    echo "$TS_STAGED" | xargs node "$PRETTIER_BIN" --write
  else
    echo "$TS_STAGED" | xargs npx prettier --write
  fi
  echo "$TS_STAGED" | xargs git add
fi
