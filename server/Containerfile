FROM docker.io/library/rust:1.83-bookworm AS build
WORKDIR /app

# Copy manifest first for better layer caching
COPY server/Cargo.toml server/Cargo.lock* ./
COPY server/src ./src

RUN cargo build --release --bin pinball-server

FROM docker.io/library/debian:bookworm-slim
RUN useradd -r -u 10001 appuser
COPY --from=build /app/target/release/pinball-server /usr/local/bin/pinball-server
USER appuser
EXPOSE 9001
CMD ["/usr/local/bin/pinball-server"]
