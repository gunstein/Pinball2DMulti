<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>Pinball2DMulti Bevy Client</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #050510;
        touch-action: none;
        overscroll-behavior: none;
      }
      canvas {
        display: block;
      }
    </style>
    <link
      data-trunk
      rel="rust"
      data-bin="pinball-client-bevy"
      data-wasm-opt="s"
    />
  </head>
  <body>
    <script>
      (() => {
        const VERSION_CHECK_INTERVAL_MS = 60000;
        let initialBuildVersion = null;

        const checkBuildVersion = async () => {
          try {
            const response = await fetch("/version.json", {
              cache: "no-store",
            });
            if (!response.ok) return;
            const data = await response.json();
            if (!data || !data.t) return;

            if (initialBuildVersion === null) {
              initialBuildVersion = data.t;
              return;
            }
            if (data.t !== initialBuildVersion) {
              location.reload();
            }
          } catch {
            // Ignore transient network errors in version polling.
          }
        };

        const attachCanvasFocus = () => {
          const canvas = document.querySelector("canvas");
          if (!canvas) return false;
          if (!canvas.hasAttribute("tabindex")) {
            canvas.setAttribute("tabindex", "0");
          }
          const focusCanvas = () => canvas.focus({ preventScroll: true });
          canvas.addEventListener("pointerdown", focusCanvas);
          window.addEventListener("keydown", (event) => {
            if (
              event.code === "Space" ||
              event.code === "ArrowLeft" ||
              event.code === "ArrowRight"
            ) {
              event.preventDefault();
              focusCanvas();
            }
          });
          setTimeout(focusCanvas, 0);
          return true;
        };

        if (attachCanvasFocus()) return;
        const observer = new MutationObserver(() => {
          if (attachCanvasFocus()) {
            observer.disconnect();
          }
        });
        observer.observe(document.body, { childList: true, subtree: true });

        checkBuildVersion();
        setInterval(checkBuildVersion, VERSION_CHECK_INTERVAL_MS);
      })();
    </script>
  </body>
</html>
