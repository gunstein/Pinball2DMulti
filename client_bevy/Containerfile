FROM docker.io/library/rust:1.86-bookworm AS build
WORKDIR /app

RUN rustup target add wasm32-unknown-unknown
RUN cargo install trunk --version 0.21.14 --locked

# Copy workspace manifests first for better layer caching
COPY Cargo.toml Cargo.lock* ./
COPY shared/Cargo.toml shared/Cargo.toml
COPY server/Cargo.toml server/Cargo.toml
COPY client_bevy/Cargo.toml client_bevy/Cargo.toml
COPY client_bevy/Trunk.toml client_bevy/Trunk.toml

# Create dummy source files so cargo can resolve the entire workspace
RUN mkdir -p shared/src && echo "pub mod protocol;" > shared/src/lib.rs && touch shared/src/protocol.rs
RUN mkdir -p server/src && echo "fn main() {}" > server/src/main.rs && touch server/src/lib.rs
RUN mkdir -p client_bevy/src && echo "fn main() {}" > client_bevy/src/main.rs
RUN cd client_bevy && cargo fetch --target wasm32-unknown-unknown

# Copy actual source
COPY shared/src shared/src
COPY client_bevy/src client_bevy/src
COPY client_bevy/index.html client_bevy/index.html

RUN cd client_bevy && trunk build --release

FROM docker.io/library/nginx:1.27-alpine
COPY --from=build /app/client_bevy/dist /usr/share/nginx/html
COPY client_bevy/nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
